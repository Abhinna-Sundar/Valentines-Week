<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Day 2 ‚Äî Propose Day üíç</title>
  <style>
    :root{
      --bg1:#0b1020; --bg2:#1b0f1a;
      --card:rgba(15,23,48,.86);
      --stroke:rgba(255,255,255,.14);
      --text:#f6f6fb; --muted:rgba(255,255,255,.75);
      --accent1:#ff4d7d; --accent2:#ff9a5c;
      --ok:#2fff7a; --bad:#ff5c5c;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 20%, #2a2f55 0%, transparent 60%),
        radial-gradient(1000px 700px at 80% 30%, #4b1f3a 0%, transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .wrap{ width:min(980px, 100%); }
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:22px;
      padding:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    h1{ margin:0 0 6px; font-size: clamp(22px, 3.4vw, 36px); }
    h2{ margin:0 0 6px; font-size: 18px; }
    p{ margin:8px 0; color:var(--muted); line-height:1.55; }
    .topbar{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:14px;
    }
    .digits{ display:flex; gap:8px; align-items:center; }
    .digitBox{
      width:36px; height:42px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.18);
      display:grid; place-items:center;
      font-weight:900;
      color:rgba(255,255,255,.25);
    }
    .digitBox.on{ color:rgba(255,255,255,.95); }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media(max-width:840px){ .grid2{ grid-template-columns:1fr; } }

    .panel{
      padding:14px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
    }
    .btn{
      cursor:pointer;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      width:100%;
      font-weight:900;
      color:var(--text);
      background:linear-gradient(135deg, var(--accent1), var(--accent2));
      user-select:none;
      transition: transform .08s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      font-weight:800;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    .small{ font-size:13px; color:var(--muted); }

    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      display:none;
    }
    .toast.ok{ display:block; border-color: rgba(47,255,122,.3); background:rgba(47,255,122,.10); color:#c9ffe4; }
    .toast.bad{ display:block; border-color: rgba(255,92,92,.3); background:rgba(255,92,92,.10); color:#ffd0d0; }

    .section{ display:none; }
    .section.active{ display:block; }

    .flagRow{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .flagImg{
      width:min(420px, 100%);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      overflow:hidden;
    }
    .flagImg img{ width:100%; height:auto; display:block; }

    .mapWrap{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      overflow:hidden;
    }
    svg{ width:100%; height:auto; display:block; }

    .overlay{
      position:fixed; inset:0;
      display:none; place-items:center;
      background: rgba(0,0,0,.62);
      padding:18px;
      z-index:40;
    }
    .overlay.show{ display:grid; }
    .modal{
      width:min(560px, 100%);
      background: rgba(15,23,48,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:16px;
      box-shadow:0 18px 70px rgba(0,0,0,.55);
    }
    .bigDigit{
      font-size:58px;
      font-weight:1000;
      letter-spacing:.08em;
      text-align:center;
      margin: 8px 0 6px;
    }
    .center{ text-align:center; }
    .pinBoxes{ display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap; }
    .pinBox{
      width: 44px; height: 54px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      font-size: 26px; font-weight: 900;
    }
    .keypad{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:12px; }
    .key{
      padding:14px 0;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .shake{ animation: shake .32s ease; }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-6px); }
      50%{ transform: translateX(6px); }
      75%{ transform: translateX(-4px); }
      100%{ transform: translateX(0); }
    }
    #photoWrap{
      display:none;
      margin-top:12px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    #photoWrap.show{ display:block; }
    #photoWrap img{ width:100%; height:auto; display:block; }
    .wordCard{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding:12px;
    }
    .wordBig{ font-size:34px; font-weight:1000; letter-spacing:.08em; margin-top:6px; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="topbar">
      <div class="pill">Day 2 ‚Ä¢ Propose Day üíç</div>
      <div class="pill">Finish 6 mini-games ‚Üí get digits ‚Üí enter the magic number</div>
      <div class="digits" aria-label="digits progress">
        <div class="digitBox" id="d0">‚Ä¢</div>
        <div class="digitBox" id="d1">‚Ä¢</div>
        <div class="digitBox" id="d2">‚Ä¢</div>
        <div class="digitBox" id="d3">‚Ä¢</div>
        <div class="digitBox" id="d4">‚Ä¢</div>
        <div class="digitBox" id="d5">‚Ä¢</div>
      </div>
    </div>

    <h1>Country Quest üåç</h1>
    <p>Each mini-game gives you <b>one digit</b>. At the end, enter the <b>magic number</b> to unlock the gift.</p>

    <!-- SECTION 1 -->
    <div class="section active" id="s1">
      <div class="grid2">
        <div class="panel">
          <h2>(i) Unscramble 3 countries</h2>
          <p class="small">Type the correct country name.</p>
          <div id="scrambleArea"></div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="scrCheck">Check answers</button>
          </div>
          <div class="toast" id="scrToast"></div>
        </div>
        <div class="panel">
          <h2>Rules</h2>
          <p class="small">You need all 3 correct to pass.</p>
        </div>
      </div>
    </div>

    <!-- SECTION 2 -->
    <div class="section" id="s2">
      <div class="grid2">
        <div class="panel">
          <h2>(ii) Green-majority flags</h2>
          <p class="small">Type <b>3 countries</b> whose flags are mostly green. Separate by commas.</p>
          <div class="small">Possible answers: Bangladesh, Saudi Arabia, Pakistan, Nigeria, Brazil, Mauritania, Zambia</div>
          <div style="margin-top:10px;">
            <input id="greenInput" type="text" placeholder="Type 3 countries, separated by commas"/>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="greenCheck">Check</button>
          </div>
          <div class="toast" id="greenToast"></div>
        </div>
        <div class="panel">
          <h2>Rule</h2>
          <p class="small">Pick exactly 3 from the list.</p>
        </div>
      </div>
    </div>

    <!-- SECTION 3 -->
    <div class="section" id="s3">
      <div class="grid2">
        <div class="panel">
          <h2>(iii) Population giants</h2>
          <p class="small">Name <b>7 of the top 10 most populated countries</b>. Separate by commas.</p>
          <input id="popInput" type="text" placeholder="Write any 7, separated by commas"/>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="popCheck">Check</button>
          </div>
          <div class="toast" id="popToast"></div>
        </div>
        <div class="panel">
          <h2>Rule</h2>
          <p class="small">Any 7 correct is enough.</p>
        </div>
      </div>
    </div>

    <!-- SECTION 4 -->
    <div class="section" id="s4">
      <div class="grid2">
        <div class="panel">
          <h2>(iv) Guess 3 flags</h2>
          <p class="small">Look at the flag and type the country name.</p>

          <div class="flagRow">
            <div class="flagImg"><img id="flagImg" alt="Flag"/></div>
            <div style="flex:1; min-width:220px;">
              <div class="small" id="flagRoundLabel">Round 1/3</div>
              <input id="flagInput" type="text" placeholder="Type the country name"/>
              <div class="row" style="margin-top:10px;">
                <button class="btn" id="flagCheck">Check</button>
              </div>
              <div class="toast" id="flagToast"></div>
            </div>
          </div>

        </div>
        <div class="panel">
          <h2>Rule</h2>
          <p class="small">Spelling matters, but caps don‚Äôt.</p>
        </div>
      </div>
    </div>

    <!-- SECTION 5 -->
    <div class="section" id="s5">
      <div class="grid2">
        <div class="panel">
          <h2>(v) Symmetrical flags</h2>
          <p class="small">Name <b>3 countries</b> with symmetrical flags. Separate by commas.</p>
          <input id="symInput" type="text" placeholder="Type 3 countries, separated by commas"/>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="symCheck">Check</button>
          </div>
          <div class="toast" id="symToast"></div>
        </div>
        <div class="panel">
          <h2>Rule</h2>
          <p class="small">We accept: Japan, Switzerland, Georgia, Honduras, Bangladesh (any 3).</p>
        </div>
      </div>
    </div>

    <!-- SECTION 6 -->
    <div class="section" id="s6">
      <div class="grid2">
        <div class="panel">
          <h2>(vi) Country by borders</h2>
          <p class="small">A country is highlighted in <b>bright red</b>. Type its name.</p>
          <div class="mapWrap">
            <svg id="mapSvg" viewBox="0 0 1000 520" preserveAspectRatio="xMidYMid meet"></svg>
          </div>
          <div style="margin-top:10px;">
            <input id="mapGuess" type="text" placeholder="Your guess..."/>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="mapCheck">Check</button>
          </div>
          <div class="toast" id="mapToast"></div>
        </div>
        <div class="panel">
          <h2>Note</h2>
          <p class="small">If the map doesn‚Äôt load, refresh once.</p>
        </div>
      </div>
    </div>

    <!-- FINAL -->
    <div class="section" id="final">
      <div class="panel">
        <h2>All done üòå</h2>
        <p class="small">Now enter the <b>magic number</b>.</p>
        <button class="btn" id="openLock">Enter magic number</button>
      </div>
    </div>

  </div>
</div>

<!-- Digit popup -->
<div class="overlay" id="digitOverlay">
  <div class="modal">
    <div class="center" style="color:var(--muted);">You got a digit</div>
    <div class="bigDigit" id="digitBig">1</div>
    <p class="center" style="color:var(--muted); margin-top:0;">Remember it. Keep going.</p>
    <button class="btn" id="digitContinue">Continue</button>
  </div>
</div>

<!-- Lock / photo modal -->
<div class="overlay" id="lockOverlay">
  <div class="modal" id="lockModal">
    <h2 id="lockTitle">Magic Number ‚ú®</h2>
    <p id="lockText" style="color:var(--muted);">Enter the 6-digit magic number.</p>

    <div class="pinBoxes">
      <div class="pinBox" id="p0"></div>
      <div class="pinBox" id="p1"></div>
      <div class="pinBox" id="p2"></div>
      <div class="pinBox" id="p3"></div>
      <div class="pinBox" id="p4"></div>
      <div class="pinBox" id="p5"></div>
    </div>

    <div class="keypad" id="keypad"></div>

    <div class="row" style="margin-top:10px;">
      <button class="btn secondary" id="clearBtn">Clear</button>
      <button class="btn" id="unlockBtn">Unlock</button>
    </div>

    <div id="photoWrap">
      <img src="us.jpg" alt="Us"
           onerror="this.outerHTML='<div style=&quot;padding:12px;color:#ffd0d0&quot;><b>Missing us.jpg</b><br/>Put a photo named <b>us.jpg</b> inside <b>day2/</b>.</div>';">
    </div>

    <button class="btn secondary" id="resetBtn" style="margin-top:10px; display:none;">
      Reset game ‚Üª
    </button>

    <div class="wordCard" id="wordCard" style="display:none;">
      <div style="color:var(--muted); font-size:13px;">Word of the Day</div>
      <div class="wordBig" id="word">YOU</div>
      <p class="small" style="margin:8px 0 0;">Please remember this word carefully.</p>
      <button class="btn" id="rememberBtn" style="margin-top:10px;">I‚Äôll remember it ‚úÖ</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3.1.0/dist/topojson-client.min.js"></script>

<script>
(() => {
  const KEY = "val_week_day2_countryquest_v4";

  // She receives digits in this order (one per game):
  const AWARD_DIGITS = ["1","5","2","1","0","2"];  // 152102

  // But the magic number she must enter is:
  const PASSCODE = "121025";
  const WORD_OF_DAY = "YOU";

  const $ = (id) => document.getElementById(id);
  const norm = (s) => (s||"")
    .toLowerCase()
    .replace(/[^a-z\s]/g," ")
    .replace(/\s+/g," ")
    .trim();
  const unique = (arr) => [...new Set(arr)];

  function showToast(id, type, text){
    const el = $(id);
    el.className = "toast " + type;
    el.textContent = text;
    el.style.display = type ? "block" : "none";
  }

  function setSection(id){
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    $(id).classList.add("active");
  }

  const state = loadState();
  updateDigitBoxes();
  route();

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if (!raw) return { stage:1, awardedCount:0, solved:{} };
      const s = JSON.parse(raw);
      return {
        stage: Math.min(7, Math.max(1, s.stage || 1)),
        awardedCount: Math.min(6, Math.max(0, s.awardedCount || 0)),
        solved: s.solved || {}
      };
    } catch {
      return { stage:1, awardedCount:0, solved:{} };
    }
  }
  function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  function updateDigitBoxes(){
    for (let i=0;i<6;i++){
      const box = $("d"+i);
      if (state.awardedCount > i){
        box.classList.add("on");
        box.textContent = AWARD_DIGITS[i];
      } else {
        box.classList.remove("on");
        box.textContent = "‚Ä¢";
      }
    }
  }

  function awardDigit(){
    const digit = AWARD_DIGITS[state.awardedCount];
    $("digitBig").textContent = digit;
    $("digitOverlay").classList.add("show");
  }

  $("digitContinue").onclick = () => {
    $("digitOverlay").classList.remove("show");
    state.awardedCount++;
    updateDigitBoxes();
    state.stage++;
    saveState();
    route();
  };

  function route(){
    if (state.stage === 1) setSection("s1");
    else if (state.stage === 2) setSection("s2");
    else if (state.stage === 3) setSection("s3");
    else if (state.stage === 4) setSection("s4");
    else if (state.stage === 5) setSection("s5");
    else if (state.stage === 6) setSection("s6");
    else setSection("final");
  }

  // (i) Unscramble (custom)
  const SCRAMBLE = [
    { scrambled: "TEGUALAMA", answer: "guatemala" },
    { scrambled: "BBAMEWZI",  answer: "zimbabwe" },
    { scrambled: "POGASIREN", answer: "singapore" }
  ];

  function renderScramble(){
    const wrap = $("scrambleArea");
    wrap.innerHTML = "";
    SCRAMBLE.forEach((q, idx) => {
      const div = document.createElement("div");
      div.style.marginTop = "10px";
      div.innerHTML = `
        <div class="small"><b>Scramble ${idx+1}:</b> ${q.scrambled}</div>
        <input type="text" id="scrIn${idx}" placeholder="Your answer..." />
      `;
      wrap.appendChild(div);
    });
  }
  renderScramble();

  $("scrCheck").onclick = () => {
    let ok = 0;
    for (let i=0;i<SCRAMBLE.length;i++){
      const got = norm($("scrIn"+i).value);
      if (got === SCRAMBLE[i].answer) ok++;
    }
    if (ok === 3){
      showToast("scrToast", "ok", "Perfect ‚úÖ Moving on‚Ä¶");
      if (!state.solved.s1){
        state.solved.s1 = true; saveState();
        awardDigit();
      }
    } else {
      showToast("scrToast", "bad", `You got ${ok}/3. Try again üôÇ`);
    }
  };

  // (ii) Green-majority flags ‚Äî free text, but must pick 3 from list
  const GREEN_ALLOWED = new Set([
    "bangladesh","saudi arabia","pakistan","nigeria","brazil","mauritania","zambia"
  ]);
  const GREEN_CORRECT = new Set([
    // pick 3 correct from the allowed list that are clearly green-dominant
    "saudi arabia","pakistan","nigeria"
  ]);

  $("greenCheck").onclick = () => {
    const raw = $("greenInput").value || "";
    const parts = unique(raw.split(",").map(s => norm(s)).filter(Boolean));

    if (parts.length !== 3){
      showToast("greenToast","bad","Please type exactly 3 countries (comma-separated).");
      return;
    }

    // must be from allowed list
    for (const p of parts){
      if (!GREEN_ALLOWED.has(p)){
        showToast("greenToast","bad","Please choose only from the provided list.");
        return;
      }
    }

    // check correctness
    let ok = 0;
    const picked = new Set(parts);
    picked.forEach(p => { if (GREEN_CORRECT.has(p)) ok++; });

    if (ok === 3){
      showToast("greenToast","ok","Correct ‚úÖ");
      if (!state.solved.s2){
        state.solved.s2 = true; saveState();
        awardDigit();
      }
    } else {
      showToast("greenToast","bad","Not quite üôÇ Try again.");
    }
  };

  // (iii) 7 of top 10 most populated (no examples in box)
  const TOP10 = new Set([
    "india","china","united states","usa","us","indonesia","pakistan","nigeria","brazil","bangladesh","russia","ethiopia"
  ]);
  const TOP10_CANON = new Set([
    "india","china","united states","indonesia","pakistan","nigeria","brazil","bangladesh","russia","ethiopia"
  ]);

  $("popCheck").onclick = () => {
    const raw = $("popInput").value || "";
    const parts = unique(raw.split(",").map(s => norm(s)).filter(Boolean));
    if (parts.length < 7){
      showToast("popToast","bad","Write at least 7 countries (comma-separated).");
      return;
    }

    const mapped = parts.map(p => {
      if (p === "us" || p === "u s" || p === "u s a" || p === "america") return "united states";
      return p;
    });

    const hits = new Set();
    mapped.forEach(m => {
      if (TOP10.has(m)){
        if (m === "usa" || m === "us") m = "united states";
        if (TOP10_CANON.has(m)) hits.add(m);
      }
    });

    if (hits.size >= 7){
      showToast("popToast","ok",`Great ‚úÖ (${hits.size}/10 correct)`);
      if (!state.solved.s3){
        state.solved.s3 = true; saveState();
        awardDigit();
      }
    } else {
      showToast("popToast","bad",`You got ${hits.size}/10. Need at least 7. Try again üôÇ`);
    }
  };

  // (iv) Flag -> type name (Burma, Honduras, Zimbabwe)
  // Burma flag code: mm (Myanmar)
  const FLAG_ROUNDS = [
    { name:"Myanmar", aliases:["myanmar","burma"], iso:"mm" },
    { name:"Honduras", aliases:["honduras"], iso:"hn" },
    { name:"Zimbabwe", aliases:["zimbabwe"], iso:"zw" }
  ];
  let flagIdx = 0;

  function setFlagRound(){
    const r = FLAG_ROUNDS[flagIdx];
    $("flagRoundLabel").textContent = `Round ${flagIdx+1}/3`;
    $("flagInput").value = "";
    $("flagImg").src = `https://flagcdn.com/w640/${r.iso}.png`;
    showToast("flagToast","", "");
  }
  setFlagRound();

  $("flagCheck").onclick = () => {
    const got = norm($("flagInput").value);
    const r = FLAG_ROUNDS[flagIdx];
    const ok = r.aliases.includes(got);

    if (ok){
      showToast("flagToast","ok","Correct ‚úÖ");
      flagIdx++;
      if (flagIdx >= FLAG_ROUNDS.length){
        if (!state.solved.s4){
          state.solved.s4 = true; saveState();
          awardDigit();
        }
      } else {
        setFlagRound();
      }
    } else {
      showToast("flagToast","bad","Not quite üôÇ Try again.");
    }
  };

  // (v) Symmetrical flags (accepted set you requested)
  const SYM = new Set(["japan","switzerland","georgia","honduras","bangladesh"]);

  $("symCheck").onclick = () => {
    const raw = $("symInput").value || "";
    const parts = unique(raw.split(",").map(s => norm(s)).filter(Boolean));

    if (parts.length < 3){
      showToast("symToast","bad","Please type 3 countries (comma-separated).");
      return;
    }

    const hits = new Set();
    parts.forEach(m => { if (SYM.has(m)) hits.add(m); });

    if (hits.size >= 3){
      showToast("symToast","ok","Correct ‚úÖ");
      if (!state.solved.s5){
        state.solved.s5 = true; saveState();
        awardDigit();
      }
    } else {
      showToast("symToast","bad","Not quite üôÇ Try again.");
    }
  };

  // (vi) Map (country by borders) ‚Äî make red VERY visible
  const MAP_ROUNDS = [
    { name:"Italy" },
    { name:"India" },
    { name:"Brazil" }
  ];
  let mapIdx = 0;

  $("mapCheck").onclick = () => {
    const got = norm($("mapGuess").value);
    if (got === norm(MAP_ROUNDS[mapIdx].name)){
      showToast("mapToast","ok","Correct ‚úÖ");
      mapIdx++;
      $("mapGuess").value = "";
      if (mapIdx >= MAP_ROUNDS.length){
        if (!state.solved.s6){
          state.solved.s6 = true; saveState();
          awardDigit();
        }
      } else {
        drawMapRound();
      }
    } else {
      showToast("mapToast","bad","Not quite üôÇ Try again.");
    }
  };

  async function drawMapRound(){
    showToast("mapToast","", "");
    const svg = d3.select("#mapSvg");
    svg.selectAll("*").remove();

    const topo = await fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(r => r.json());
    const countries = topojson.feature(topo, topo.objects.countries);

    const names = await fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.tsv").then(r=>r.text());
    const idToName = new Map(names.trim().split("\n").slice(1).map(line => {
      const [id, name] = line.split("\t");
      return [+id, name];
    }));

    const width = 1000, height = 520;
    const projection = d3.geoNaturalEarth1().fitSize([width, height], countries);
    const path = d3.geoPath(projection);

    const targetName = MAP_ROUNDS[mapIdx].name;

    // Darker background to make highlight pop
    svg.append("rect")
      .attr("x", 0).attr("y", 0)
      .attr("width", width).attr("height", height)
      .attr("fill", "rgba(0,0,0,.10)");

    svg.append("g")
      .selectAll("path")
      .data(countries.features)
      .join("path")
      .attr("d", path)
      .attr("fill", d => {
        const nm = idToName.get(d.id) || "";
        return (norm(nm) === norm(targetName)) ? "#ff0000" : "rgba(255,255,255,.04)";
      })
      .attr("stroke", d => {
        const nm = idToName.get(d.id) || "";
        return (norm(nm) === norm(targetName)) ? "rgba(255,255,255,.95)" : "rgba(255,255,255,.10)";
      })
      .attr("stroke-width", d => {
        const nm = idToName.get(d.id) || "";
        return (norm(nm) === norm(targetName)) ? 2.4 : 0.6;
      });

    // Title
    svg.append("text")
      .attr("x", 20).attr("y", 34)
      .attr("fill", "rgba(255,255,255,.88)")
      .attr("font-size", 18)
      .attr("font-weight", 900)
      .text(`Round ${mapIdx+1}/3`);

    // Legend bubble
    svg.append("text")
      .attr("x", 20).attr("y", 58)
      .attr("fill", "rgba(255,255,255,.70)")
      .attr("font-size", 13)
      .attr("font-weight", 700)
      .text("Find the BRIGHT RED country.");
  }

  // Ensure map draws on entry to section 6
  const originalRoute = route;
  route = function(){
    originalRoute();
    if (state.stage === 6){
      drawMapRound().catch(() => showToast("mapToast","bad","Map failed to load. Refresh once."));
    }
  };
  route();

  // Final lock
  let entered = "";

  $("openLock").onclick = () => {
    $("lockOverlay").classList.add("show");
    buildKeypad();
    entered = "";
    setPin();
    $("lockText").textContent = "Enter the 6-digit magic number.";
  };

  function setPin(){
    for (let i=0;i<6;i++){
      $("p"+i).textContent = entered[i] ? "‚Ä¢" : "";
    }
  }

  function buildKeypad(){
    const kp = $("keypad");
    kp.innerHTML = "";
    const keys = ["1","2","3","4","5","6","7","8","9","‚å´","0","OK"];
    keys.forEach(k => {
      const div = document.createElement("div");
      div.className = "key";
      div.textContent = k;
      div.onclick = () => {
        if (k === "‚å´"){
          entered = entered.slice(0,-1);
          setPin();
          return;
        }
        if (k === "OK"){
          tryUnlock();
          return;
        }
        if (entered.length >= 6) return;
        entered += k;
        setPin();
      };
      kp.appendChild(div);
    });
  }

  $("clearBtn").onclick = () => { entered=""; setPin(); };

  function tryUnlock(){
    const modal = $("lockModal");
    if (entered.length !== 6){
      modal.classList.remove("shake"); void modal.offsetWidth; modal.classList.add("shake");
      $("lockText").textContent = "Enter all 6 digits üôÇ";
      return;
    }
    if (entered === PASSCODE){
      $("lockText").textContent = "Unlocked üòå";
      $("photoWrap").classList.add("show");
      $("resetBtn").style.display = "block";
      $("wordCard").style.display = "block";
      $("word").textContent = WORD_OF_DAY;

      $("keypad").querySelectorAll(".key").forEach(k => k.style.pointerEvents="none");
      $("unlockBtn").disabled = true; $("unlockBtn").style.opacity = "0.6";
      $("clearBtn").disabled = true; $("clearBtn").style.opacity = "0.6";
    } else {
      modal.classList.remove("shake"); void modal.offsetWidth; modal.classList.add("shake");
      $("lockText").textContent = "Not quite. The digits you received might need reordering.";
      entered = "";
      setPin();
    }
  }

  $("unlockBtn").onclick = tryUnlock;

  $("resetBtn").onclick = () => {
    localStorage.removeItem(KEY);
    location.reload();
  };

  $("rememberBtn").onclick = () => {
    localStorage.removeItem(KEY);
    location.reload();
  };

})();
</script>
</body>
</html>
