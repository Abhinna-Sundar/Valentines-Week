<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rose Day Quest ‚Äî Heidelberg üåπ</title>

  <!-- Leaflet (map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg1:#0b1020; --bg2:#1b0f1a; --card:#0f1730cc; --text:#f6f6fb; --muted:#c9c9d6;
      --accent1:#ff4d7d; --accent2:#ff9a5c;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 20%, #2a2f55 0%, transparent 60%),
                  radial-gradient(1000px 700px at 80% 30%, #4b1f3a 0%, transparent 55%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      padding: 18px;
    }
    .wrap{ width:min(980px, 100%); }
    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      padding: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      position: relative;
    }
    h1{ margin:0 0 6px; font-size: clamp(24px, 3.6vw, 38px); }
    p{ margin: 8px 0; color: var(--muted); line-height: 1.5; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px; border-radius: 999px;
      background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12);
      font-size: 14px; color: var(--muted);
    }
    .row{ display:flex; flex-wrap:wrap; gap:14px; margin-top: 14px; }
    .panel{ flex: 1 1 280px; padding:14px; border-radius:16px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); }

    .btn{
      cursor:pointer;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: var(--text);
      padding: 12px 14px;
      font-weight: 800;
      width:100%;
      transition: transform .08s ease;
      user-select:none;
      touch-action: manipulation;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(1px); }
    .btn-secondary{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      font-weight: 650;
    }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width:700px){ .grid2{ grid-template-columns: 1fr; } }

    /* App sections */
    .section{ display:none; }
    .section.active{ display:block; }

    /* Map */
    #mapWrap{ overflow:hidden; border-radius:16px; border:1px solid rgba(255,255,255,.16); }
    #map{ height: 520px; width: 100%; }
    @media (max-width:700px){ #map{ height: 480px; } }
    .hud{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top: 10px;
    }
    .progress{
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);
      padding: 8px 12px; border-radius: 999px;
      font-size: 14px; color: var(--muted);
    }
    .bar{
      width: 180px; height: 8px; border-radius: 999px; overflow:hidden;
      background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.12);
    }
    .bar > div{ height:100%; width:0%; background: linear-gradient(135deg, var(--accent1), var(--accent2)); }

    /* Modal */
    .modalBackdrop{
      position: fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding: 18px;
    }
    .modalBackdrop.show{ display:flex; }
    .modal{
      width: min(740px, 100%);
      background: rgba(15,23,48,.92);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 18px 70px rgba(0,0,0,.5);
      backdrop-filter: blur(10px);
    }
    .modal h2{ margin: 0 0 6px; font-size: 20px; }
    .small{ font-size: 13px; color: var(--muted); }
    .toast{ margin-top: 10px; padding: 10px 12px; border-radius: 12px; display:none; }
    .ok{ display:block; background: rgba(0,255,160,.12); border:1px solid rgba(0,255,160,.25); color:#bfffe8; }
    .bad{ display:block; background: rgba(255,70,70,.12); border:1px solid rgba(255,70,70,.25); color:#ffd0d0; }
    input{
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding: 12px 12px;
      outline: none;
      font: inherit;
    }

    /* Bridge planks */
    .planks{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .plank{
      padding: 14px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      text-align:center;
      font-weight:800;
      user-select:none;
      cursor:pointer;
      transition: transform .08s ease, filter .15s ease;
    }
    .plank:hover{ transform: translateY(-1px); }
    .plank.done{ background: rgba(0,255,160,.10); border-color: rgba(0,255,160,.22); }
    .plank.hint{ filter: brightness(1.18); }

    /* Hold-to-bloom */
    .holdWrap{
      margin-top: 10px;
      display:flex; flex-direction:column; gap: 10px; align-items:center;
    }
    .holdBtn{
      width: 180px; height: 180px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: radial-gradient(circle at 30% 30%, #ffd1dc 0%, #ff4d7d 38%, #b10b3a 72%, #4a061a 100%);
      display:flex; align-items:center; justify-content:center;
      font-size: 44px;
      box-shadow: 0 18px 60px rgba(255,77,125,.25);
      user-select:none;
      touch-action: none;
      position: relative;
      overflow:hidden;
    }
    .ring{
      position:absolute; inset: 10px;
      border-radius: 999px;
      border: 3px solid rgba(255,255,255,.18);
    }
    .ringFill{
      position:absolute; inset: 10px;
      border-radius: 999px;
      background: conic-gradient(var(--accent2) 0deg, rgba(255,255,255,0) 0deg);
      mask: radial-gradient(circle, transparent 68%, #000 69%);
      -webkit-mask: radial-gradient(circle, transparent 68%, #000 69%);
      transform: rotate(-90deg);
    }

    /* Qs */
    .qCard{ margin-top: 10px; padding: 14px; border-radius: 16px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); }
    .optGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    @media (max-width:700px){ .optGrid{ grid-template-columns:1fr; } }

    /* Scratch */
    .giftWrap{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; align-items:start; }
    @media (max-width:700px){ .giftWrap{ grid-template-columns: 1fr; } }
    .scratchBox{
      position: relative;
      border-radius: 16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      min-height: 320px;
    }
    .scratchBox img{ width:100%; height:auto; display:block; }
    #scratch{
      position:absolute; inset:0;
      width:100%; height:100%;
      touch-action:none;
    }

    canvas#fx{ position:fixed; inset:0; pointer-events:none; }
  </style>
</head>

<body>
<canvas id="fx"></canvas>

<div class="wrap">
  <div class="card">

    <!-- INTRO -->
    <section id="intro" class="section active">
      <div class="pill">üåπ Rose Day Quest ‚Ä¢ Heidelberg Treasure Hunt</div>
      <h1>Hi Finnja (aka Tiya) ‚ú®</h1>
      <p>
        I hid a rose in Heidelberg ‚Äî not in a place, but in moments.
        Find the path, answer my questions, and your gift will bloom.
      </p>

      <div class="row">
        <div class="panel">
          <p class="small" id="timeGreeting"></p>
          <p class="small">This takes ~10 minutes. No stress. Just vibes.</p>
          <button class="btn" id="startBtn">Enter the Heidelberg Map ‚Üí</button>
        </div>
        <div class="panel">
          <p><b>How it works</b></p>
          <p class="small">Complete 3 locations on the map (in order). Then 3 questions. Then scratch to reveal the gift.</p>
          <button class="btn btn-secondary" id="resetAllBtn">Reset progress</button>
        </div>
      </div>
    </section>

    <!-- MAP -->
    <section id="mapSection" class="section">
      <div class="pill">Act I ‚Ä¢ üó∫Ô∏è Treasure Hunt</div>
      <h1>Find the Rose Path</h1>
      <p>Tap the glowing marker. Complete the location. Move on.</p>

      <div id="mapWrap">
        <div id="map"></div>
      </div>

      <div class="hud">
        <div class="progress">
          <span id="progText">Progress: 0 / 3</span>
          <div class="bar"><div id="barFill"></div></div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-secondary" id="backToIntro">‚Üê Back</button>
          <button class="btn" id="toQuestions" style="display:none;">Continue ‚Üí Questions</button>
        </div>
      </div>

      <p class="small">Tip: Zoom and pan. The markers are near the river. üòâ</p>
    </section>

    <!-- QUESTIONS -->
    <section id="questions" class="section">
      <div class="pill">Act II ‚Ä¢ üí¨ 3 Questions</div>
      <h1>You found the path, Tiya üåπ</h1>
      <p>Before I give you the rose‚Ä¶ answer me honestly.</p>

      <div class="qCard" id="qArea"></div>

      <div class="hud">
        <button class="btn btn-secondary" id="backToMap">‚Üê Back to map</button>
        <button class="btn" id="finishQuestions" style="display:none;">Reveal the gift ‚Üí</button>
      </div>
    </section>

    <!-- GIFT -->
    <section id="gift" class="section">
      <div class="pill">Finale ‚Ä¢ üéÅ Scratch to Reveal</div>
      <h1>This rose is yours üåπ</h1>
      <p>Scratch gently to reveal the gift.</p>

      <div class="giftWrap">
        <div class="panel">
          <div class="scratchBox" id="scratchBox">
            <img id="giftImg" src="us.jpg" alt="Us"
                 onerror="this.outerHTML='<div style=&quot;padding:14px;color:#ffd1dc&quot;><b>Missing us.jpg</b><br/>Put a photo named <b>us.jpg</b> next to <b>index.html</b> in your repo.</div>';">
            <canvas id="scratch"></canvas>
          </div>
          <div class="toast" id="scratchMsg"></div>
          <button class="btn" id="moreFx">More confetti ‚ú®</button>
          <p class="small">If you want, I‚Äôll reuse this engine for Propose Day too.</p>
        </div>

        <div class="panel">
          <p><b>Message from Abhi</b></p>
          <p class="small" id="finalNote"></p>
          <button class="btn btn-secondary" id="restart">Play again</button>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- Modal -->
<div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div id="modalContent"></div>
  </div>
</div>

<script>
(() => {
  // ===== Customizable text =====
  const FINAL_NOTE =
    "Happy Rose Day üåπ\n\nTiya, you make my world softer and brighter.\nThis is a small rose‚Ä¶ for a very big place you have in my life.\n‚Äî Abhi";

  // ===== Persistence keys =====
  const KEY = "rose_day_heidelberg_v1";
  const state = loadState();

  // ===== Sections =====
  const $ = (id) => document.getElementById(id);
  const intro = $("intro"), mapSection = $("mapSection"), questions = $("questions"), gift = $("gift");

  function show(section){
    [intro,mapSection,questions,gift].forEach(s => s.classList.remove("active"));
    section.classList.add("active");
  }

  // Greeting
  const hr = new Date().getHours();
  $("timeGreeting").textContent =
    (hr < 12) ? "Good morning, Tiya üå∏ Ready to hunt a rose?"
    : (hr < 18) ? "Good afternoon, Tiya ‚ú® Ready for a little map quest?"
    : "Good evening, Tiya üåô Let‚Äôs find your rose in Heidelberg.";

  $("finalNote").textContent = FINAL_NOTE;

  // Reset
  $("resetAllBtn").onclick = () => {
    localStorage.removeItem(KEY);
    location.reload();
  };

  // Navigation
  $("startBtn").onclick = () => { show(mapSection); initMapOnce(); };
  $("backToIntro").onclick = () => show(intro);
  $("backToMap").onclick = () => show(mapSection);
  $("restart").onclick = () => { localStorage.removeItem(KEY); location.reload(); };

  // ===== Map + Hunt =====
  let mapInitialized = false;
  let map, markers = {};
  const LOCS = [
    { id:"altstadt", name:"Altstadt (Old Town)", coords:[49.4099, 8.6947], step:1 },
    { id:"bridge",   name:"Old Bridge",          coords:[49.4113, 8.7043], step:2 },
    { id:"castle",   name:"Heidelberg Castle",   coords:[49.4102, 8.7157], step:3 }
  ];

  function initMapOnce(){
    if (mapInitialized) { updateProgressUI(); return; }
    mapInitialized = true;

    map = L.map("map", { zoomControl:true }).setView([49.4097, 8.7020], 15);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Markers
    LOCS.forEach(loc => {
      const m = L.circleMarker(loc.coords, {
        radius: 10,
        color: "rgba(255,255,255,.65)",
        weight: 2,
        fillColor: "#ff4d7d",
        fillOpacity: 0.25
      }).addTo(map);

      m.bindTooltip(loc.name, { direction:"top", opacity:0.9 });
      m.on("click", () => onMarkerClick(loc));
      markers[loc.id] = m;
    });

    updateProgressUI();
  }

  function onMarkerClick(loc){
    // Enforce order
    if (state.huntStep + 1 !== loc.step) {
      const next = LOCS.find(x => x.step === state.huntStep + 1);
      openModal(`
        <h2>Not yet üôÇ</h2>
        <p class="small">The next stop is: <b>${next.name}</b>.</p>
        <div class="grid2" style="margin-top:10px;">
          <button class="btn btn-secondary" onclick="window.__closeModal()">Okay</button>
          <button class="btn" onclick="window.__panTo('${next.id}')">Show me</button>
        </div>
      `);
      return;
    }

    if (loc.id === "altstadt") openAltstadt();
    if (loc.id === "bridge") openBridge();
    if (loc.id === "castle") openCastle();
  }

  // ===== Modal helpers =====
  const backdrop = $("modalBackdrop");
  const modalContent = $("modalContent");

  window.__closeModal = () => closeModal();
  window.__panTo = (id) => {
    const loc = LOCS.find(x => x.id === id);
    if (loc && map) map.setView(loc.coords, 16, { animate:true });
    closeModal();
  };

  function openModal(html){
    modalContent.innerHTML = html;
    backdrop.classList.add("show");
    backdrop.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    backdrop.classList.remove("show");
    backdrop.setAttribute("aria-hidden","true");
    modalContent.innerHTML = "";
  }
  backdrop.addEventListener("click", (e) => {
    if (e.target === backdrop) closeModal();
  });

  // ===== Location 1: Altstadt (Lanterns) =====
  function openAltstadt(){
    const lanternState = { a:false, b:false, c:false };
    openModal(`
      <h2>Altstadt ‚Ä¢ Memory Lanterns</h2>
      <p class="small">Tap all lanterns to light the first clue.</p>

      <div class="optGrid" style="margin-top:10px;">
        <button class="btn btn-secondary" id="lanA">üèÆ Lantern 1</button>
        <button class="btn btn-secondary" id="lanB">üèÆ Lantern 2</button>
        <button class="btn btn-secondary" id="lanC">üèÆ Lantern 3</button>
      </div>

      <div class="qCard" style="margin-top:12px;">
        <p class="small" id="lanText">The street is quiet‚Ä¶ pick a lantern.</p>
      </div>

      <div class="toast" id="lanToast"></div>

      <div class="grid2" style="margin-top:12px;">
        <button class="btn btn-secondary" onclick="window.__closeModal()">Later</button>
        <button class="btn" id="lanContinue" disabled style="opacity:.5; cursor:not-allowed;">Unlock next ‚Üí</button>
      </div>
    `);

    const lanText = document.getElementById("lanText");
    const toast = document.getElementById("lanToast");
    const cont = document.getElementById("lanContinue");

    function update(){
      const lit = [lanternState.a, lanternState.b, lanternState.c].filter(Boolean).length;
      if (lit === 3){
        toast.className = "toast ok";
        toast.textContent = "Lanterns lit ‚ú® The path opens.";
        cont.disabled = false;
        cont.style.opacity = "1";
        cont.style.cursor = "pointer";
      }
    }

    document.getElementById("lanA").onclick = () => { lanternState.a=true; lanText.textContent="A laugh that stayed."; update(); };
    document.getElementById("lanB").onclick = () => { lanternState.b=true; lanText.textContent="A silence that felt safe."; update(); };
    document.getElementById("lanC").onclick = () => { lanternState.c=true; lanText.textContent="A moment that mattered."; update(); };

    cont.onclick = () => {
      state.huntStep = 1;
      saveState();
      popConfetti();
      closeModal();
      updateProgressUI();
      map.setView(LOCS.find(x=>x.id==="bridge").coords, 16, { animate:true });
    };
  }

  // ===== Location 2: Old Bridge (Planks order) =====
  function openBridge(){
    const order = [1,2,3,4,5]; // simple and clean; you can randomize if you want
    let idx = 0;
    let mistakes = 0;

    openModal(`
      <h2>Old Bridge ‚Ä¢ Cross the Steps</h2>
      <p class="small">Tap the planks in order: <b>1 ‚Üí 2 ‚Üí 3 ‚Üí 4 ‚Üí 5</b>.</p>

      <div class="planks" id="planks">
        ${order.map(n => `<div class="plank" data-n="${n}">${n}</div>`).join("")}
      </div>

      <div class="toast" id="bridgeToast"></div>

      <div class="grid2" style="margin-top:12px;">
        <button class="btn btn-secondary" onclick="window.__closeModal()">Later</button>
        <button class="btn" id="bridgeContinue" disabled style="opacity:.5; cursor:not-allowed;">Unlocked ‚Üí</button>
      </div>
      <p class="small" style="margin-top:10px;">Hint: If you slip, the bridge forgives you üôÇ</p>
    `);

    const toast = document.getElementById("bridgeToast");
    const cont = document.getElementById("bridgeContinue");
    const plankEls = [...document.querySelectorAll(".plank")];

    function setHintNext(){
      plankEls.forEach(el => el.classList.remove("hint"));
      const next = plankEls.find(el => Number(el.dataset.n) === (idx+1));
      if (next) next.classList.add("hint");
    }

    setHintNext();

    plankEls.forEach(el => {
      el.onclick = () => {
        const n = Number(el.dataset.n);
        if (n === idx+1){
          el.classList.add("done");
          idx++;
          toast.className = "toast ok";
          toast.textContent = "Nice ‚ú® Keep going.";
          setHintNext();
          if (idx === 5){
            toast.textContent = "Bridge crossed üòå";
            cont.disabled = false;
            cont.style.opacity="1";
            cont.style.cursor="pointer";
          }
        } else {
          mistakes++;
          toast.className = "toast bad";
          toast.textContent = "Oops ‚Äî try again üôÇ";
          // soft reset with a little extra help
          idx = 0;
          plankEls.forEach(p => p.classList.remove("done"));
          if (mistakes >= 1) setHintNext();
        }
      };
    });

    cont.onclick = () => {
      state.huntStep = 2;
      saveState();
      popConfetti();
      closeModal();
      updateProgressUI();
      map.setView(LOCS.find(x=>x.id==="castle").coords, 16, { animate:true });
    };
  }

  // ===== Location 3: Castle (Hold 7 seconds) =====
  function openCastle(){
    let holding = false;
    let startT = 0;
    const needMs = 7000;

    openModal(`
      <h2>Heidelberg Castle ‚Ä¢ Bloom the Rose</h2>
      <p class="small">Press and hold the rose for <b>7 seconds</b>. Release early and it resets.</p>

      <div class="holdWrap">
        <div class="holdBtn" id="holdBtn">
          üåπ
          <div class="ring" aria-hidden="true"></div>
          <div class="ringFill" id="ringFill" aria-hidden="true"></div>
        </div>
        <div class="small" id="holdText">Hold gently‚Ä¶</div>
        <div class="toast" id="holdToast"></div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <button class="btn btn-secondary" onclick="window.__closeModal()">Later</button>
        <button class="btn" id="castleContinue" disabled style="opacity:.5; cursor:not-allowed;">Rose found ‚Üí</button>
      </div>
    `);

    const holdBtn = document.getElementById("holdBtn");
    const ringFill = document.getElementById("ringFill");
    const holdText = document.getElementById("holdText");
    const toast = document.getElementById("holdToast");
    const cont = document.getElementById("castleContinue");

    function setRing(pct){
      const deg = Math.max(0, Math.min(360, pct*360));
      ringFill.style.background = `conic-gradient(var(--accent2) ${deg}deg, rgba(255,255,255,0) 0deg)`;
    }
    setRing(0);

    function onDown(e){
      e.preventDefault();
      holding = true;
      startT = performance.now();
      holdText.textContent = "Don‚Äôt let go‚Ä¶";
      toast.className = "toast";
      toast.textContent = "";
      requestAnimationFrame(tick);
    }
    function onUp(e){
      if (!holding) return;
      e.preventDefault();
      holding = false;
      setRing(0);
      holdText.textContent = "Try again üôÇ";
    }

    function tick(now){
      if (!holding) return;
      const dt = now - startT;
      const pct = Math.min(1, dt / needMs);
      setRing(pct);
      if (pct >= 1){
        holding = false;
        toast.className = "toast ok";
        toast.textContent = "Rose bloomed üåπ";
        popConfetti(180);
        cont.disabled = false;
        cont.style.opacity = "1";
        cont.style.cursor = "pointer";
        holdText.textContent = "Perfect üòå";
        return;
      }
      requestAnimationFrame(tick);
    }

    // mouse + touch
    holdBtn.addEventListener("mousedown", onDown);
    holdBtn.addEventListener("mouseup", onUp);
    holdBtn.addEventListener("mouseleave", onUp);
    holdBtn.addEventListener("touchstart", onDown, { passive:false });
    holdBtn.addEventListener("touchend", onUp, { passive:false });
    holdBtn.addEventListener("touchcancel", onUp, { passive:false });

    cont.onclick = () => {
      state.huntStep = 3;
      saveState();
      closeModal();
      updateProgressUI();
      $("toQuestions").style.display = "inline-block";
      $("toQuestions").onclick = () => { show(questions); renderQuestions(); };
    };
  }

  function updateProgressUI(){
    const done = state.huntStep;
    $("progText").textContent = `Progress: ${done} / 3`;
    $("barFill").style.width = `${(done/3)*100}%`;

    // Visual marker emphasis: next location glows more
    LOCS.forEach(loc => {
      const m = markers[loc.id];
      if (!m) return;
      const isDone = done >= loc.step;
      const isNext = done + 1 === loc.step;

      m.setStyle({
        fillOpacity: isDone ? 0.55 : (isNext ? 0.40 : 0.18),
        radius: isDone ? 12 : (isNext ? 11 : 9),
        color: isDone ? "rgba(0,255,160,.75)" : "rgba(255,255,255,.60)",
        fillColor: isDone ? "#2fff7a" : "#ff4d7d"
      });
    });

    if (done === 3) {
      $("toQuestions").style.display = "inline-block";
      $("toQuestions").onclick = () => { show(questions); renderQuestions(); };
    } else {
      $("toQuestions").style.display = "none";
    }
  }

  // ===== Questions (Act II) =====
  function renderQuestions(){
    if (state.huntStep < 3) { show(mapSection); return; }

    const qArea = $("qArea");

    // question state
    const qState = state.qState || { q1:false, q2:false, q3:false, word:"" };
    state.qState = qState;
    saveState();

    function render(){
      const doneCount = [qState.q1,qState.q2,qState.q3].filter(Boolean).length;

      if (!qState.q1){
        qArea.innerHTML = `
          <p><b>Q1.</b> What makes us special?</p>
          <div class="optGrid">
            <button class="btn btn-secondary" data-a="laughs">The laughs</button>
            <button class="btn btn-secondary" data-a="silence">The silence</button>
            <button class="btn btn-secondary" data-a="chaos">The chaos</button>
            <button class="btn btn-secondary" data-a="everything">Everything</button>
          </div>
          <p class="small" style="margin-top:10px;">(There is no wrong answer. I just want yours.)</p>
        `;
        qArea.querySelectorAll("button[data-a]").forEach(b => {
          b.onclick = () => {
            qState.q1 = true;
            qState.choice = b.dataset.a;
            saveState();
            popConfetti();
            render();
          };
        });
        return;
      }

      if (!qState.q2){
        qArea.innerHTML = `
          <p><b>Q2.</b> One word that reminds you of us.</p>
          <div class="grid2" style="margin-top:10px;">
            <input id="wordIn" placeholder="type one word‚Ä¶" maxlength="24" />
            <button class="btn" id="wordBtn">Save</button>
          </div>
          <div class="toast" id="wToast"></div>
          <p class="small" style="margin-top:10px;">(I‚Äôll remember it.)</p>
        `;
        $("wordBtn").onclick = () => {
          const v = ($("wordIn").value || "").trim();
          const t = $("wToast");
          if (!v){
            t.className = "toast bad";
            t.textContent = "Give me one word üôÇ";
            return;
          }
          qState.word = v;
          qState.q2 = true;
          saveState();
          t.className = "toast ok";
          t.textContent = `Saved: "${v}" ‚ú®`;
          popConfetti();
          setTimeout(render, 600);
        };
        return;
      }

      if (!qState.q3){
        qArea.innerHTML = `
          <p><b>Q3.</b> Are you ready to receive your rose?</p>
          <button class="btn" id="yesFinal">Yes üåπ</button>
          <p class="small" style="margin-top:10px;">(Good answer üòå)</p>
        `;
        $("yesFinal").onclick = () => {
          qState.q3 = true;
          saveState();
          popConfetti(200);
          $("finishQuestions").style.display = "inline-block";
          $("finishQuestions").onclick = () => { show(gift); initScratchOnce(); };
          $("finishQuestions").click();
        };
        return;
      }

      qArea.innerHTML = `
        <p><b>All done.</b> Your word: <b>${escapeHtml(qState.word || "")}</b></p>
        <p class="small">Proceed to your gift.</p>
      `;
      $("finishQuestions").style.display = "inline-block";
      $("finishQuestions").onclick = () => { show(gift); initScratchOnce(); };
    }

    render();
  }

  // ===== Scratch Card =====
  let scratchInit = false;
  let scratchedPct = 0;
  function initScratchOnce(){
    if (scratchInit) return;
    scratchInit = true;

    const canvas = $("scratch");
    const box = $("scratchBox");
    const img = $("giftImg");

    // if image missing, don't proceed
    if (!img || !img.complete) {
      // still try; onerror handles UI
    }

    const ctx = canvas.getContext("2d");
    function resize(){
      const r = box.getBoundingClientRect();
      canvas.width = Math.floor(r.width * devicePixelRatio);
      canvas.height = Math.floor(r.height * devicePixelRatio);
      canvas.style.width = r.width + "px";
      canvas.style.height = r.height + "px";

      // draw scratch layer
      ctx.save();
      ctx.scale(devicePixelRatio, devicePixelRatio);
      ctx.globalCompositeOperation = "source-over";
      ctx.clearRect(0,0,r.width,r.height);
      // metallic-ish layer
      const g = ctx.createLinearGradient(0,0,r.width,r.height);
      g.addColorStop(0, "rgba(210,210,220,.95)");
      g.addColorStop(.5,"rgba(160,160,175,.95)");
      g.addColorStop(1, "rgba(230,230,240,.95)");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,r.width,r.height);

      // subtle text on overlay
      ctx.fillStyle = "rgba(20,20,35,.55)";
      ctx.font = "700 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Scratch to reveal your rose üåπ", 18, 34);
      ctx.restore();
    }
    resize();
    window.addEventListener("resize", resize);

    let drawing = false;

    function getPos(e){
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return {
        x: (clientX - rect.left),
        y: (clientY - rect.top),
        w: rect.width,
        h: rect.height
      };
    }

    function scratchAt(x,y){
      const radius = 22;
      const scale = devicePixelRatio;

      ctx.save();
      ctx.scale(scale, scale);
      ctx.globalCompositeOperation = "destination-out";
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    function down(e){
      e.preventDefault();
      drawing = true;
      const p = getPos(e);
      scratchAt(p.x, p.y);
      requestPct();
    }
    function move(e){
      if (!drawing) return;
      e.preventDefault();
      const p = getPos(e);
      scratchAt(p.x, p.y);
      requestPct();
    }
    function up(e){
      if (!drawing) return;
      e.preventDefault();
      drawing = false;
      requestPct(true);
    }

    canvas.addEventListener("mousedown", down);
    canvas.addEventListener("mousemove", move);
    window.addEventListener("mouseup", up);

    canvas.addEventListener("touchstart", down, { passive:false });
    canvas.addEventListener("touchmove", move, { passive:false });
    window.addEventListener("touchend", up, { passive:false });
    window.addEventListener("touchcancel", up, { passive:false });

    let pctPending = false;
    function requestPct(force=false){
      if (pctPending && !force) return;
      pctPending = true;
      setTimeout(() => {
        pctPending = false;
        scratchedPct = estimateCleared(ctx, canvas.width, canvas.height);
        state.scratch = scratchedPct;
        saveState();

        const msg = $("scratchMsg");
        if (scratchedPct >= 0.65){
          msg.className = "toast ok";
          msg.textContent = "There it is‚Ä¶ üåπ";
          // fade the remaining overlay
          ctx.save();
          ctx.globalAlpha = 0.02;
          ctx.globalCompositeOperation = "destination-out";
          ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.restore();
          popConfetti(220);
        } else {
          msg.className = "toast";
          msg.textContent = "";
        }
      }, 180);
    }

    // If returning with saved scratch progress, auto-clear some overlay
    if (state.scratch && state.scratch > 0.05){
      // cheap approximation: erase a diagonal band proportional to saved pct
      const pct = Math.min(0.8, Math.max(0.05, state.scratch));
      const rect = canvas.getBoundingClientRect();
      for (let i=0;i<1400*pct;i++){
        scratchAt(Math.random()*rect.width, Math.random()*rect.height);
      }
      requestPct(true);
    }

    $("moreFx").onclick = () => popConfetti(200);
  }

  // Estimate cleared pixels (fast-ish)
  function estimateCleared(ctx, w, h){
    // sample grid for speed
    const step = 12; // larger = faster, less accurate
    const img = ctx.getImageData(0,0,w,h).data;
    let total = 0, cleared = 0;
    for (let y=0; y<h; y+=step){
      for (let x=0; x<w; x+=step){
        total++;
        const i = (y*w + x) * 4 + 3; // alpha
        if (img[i] < 20) cleared++;
      }
    }
    return cleared / total;
  }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // ===== Confetti =====
  const fx = document.querySelector("canvas#fx");
  const fctx = fx.getContext("2d");
  let FW,FH,particles=[],anim=false;

  function fxResize(){
    FW = fx.width = window.innerWidth * devicePixelRatio;
    FH = fx.height = window.innerHeight * devicePixelRatio;
  }
  window.addEventListener("resize", fxResize);
  fxResize();

  function popConfetti(n=120){
    for (let i=0;i<n;i++){
      particles.push({
        x: Math.random()*FW,
        y: -20,
        vx: (Math.random()*2-1)*2.0,
        vy: (Math.random()*2+1)*2.2,
        r: (Math.random()*6+3),
        a: 1,
        spin:(Math.random()*2-1)*0.18
      });
    }
    if (!anim) requestAnimationFrame(tick);
    anim = true;
  }
  function tick(){
    fctx.clearRect(0,0,FW,FH);
    for (const p of particles){
      p.x += p.vx * devicePixelRatio;
      p.y += p.vy * devicePixelRatio;
      p.vy *= 1.01;
      p.a *= 0.992;

      fctx.save();
      fctx.globalAlpha = Math.max(0, Math.min(1, p.a));
      fctx.translate(p.x, p.y);
      fctx.rotate(p.spin);
      fctx.fillStyle = "white";
      fctx.fillRect(-p.r/2, -p.r/2, p.r, p.r);
      fctx.restore();
    }
    particles = particles.filter(p => p.y < FH+40 && p.a > 0.05);
    if (particles.length) requestAnimationFrame(tick);
    else anim = false;
  }

  // ===== State load/boot =====
  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if (!raw) return { huntStep: 0, qState:null, scratch:0 };
      const s = JSON.parse(raw);
      return {
        huntStep: Number(s.huntStep||0),
        qState: s.qState || null,
        scratch: Number(s.scratch||0)
      };
    }catch{
      return { huntStep: 0, qState:null, scratch:0 };
    }
  }
  function saveState(){
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  // Resume where she left
  if (state.huntStep >= 3 && state.qState && state.qState.q3){
    show(gift);
    initScratchOnce();
  } else if (state.huntStep >= 3){
    show(questions);
    renderQuestions();
  } else if (state.huntStep > 0){
    show(mapSection);
    initMapOnce();
  } else {
    show(intro);
  }

})();
</script>
</body>
</html>
